// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String?  @unique
  name      String?
  createdAt DateTime @default(now()) @map("created_at")

  @@map("users")
}

model Bill {
  id                String      @id @default(uuid())
  code              String      @unique
  title             String
  currency          String      @default("USD")
  payerDisplayName  String      @map("payer_display_name")
  payerSessionId    String?     @map("payer_session_id")
  totalAmount       Decimal     @default(0) @map("total_amount") @db.Decimal(12, 2)
  taxPercentage     Decimal     @default(0) @map("tax_percentage") @db.Decimal(5, 2)
  servicePercentage Decimal     @default(0) @map("service_percentage") @db.Decimal(5, 2)
  taxAmount         Decimal     @default(0) @map("tax_amount") @db.Decimal(12, 2)
  serviceAmount     Decimal     @default(0) @map("service_amount") @db.Decimal(12, 2)
  tipAmount         Decimal     @default(0) @map("tip_amount") @db.Decimal(12, 2)
  status            BillStatus  @default(DRAFT)
  createdAt         DateTime    @default(now()) @map("created_at")
  finalizedAt       DateTime?   @map("finalized_at")
  autoCloseAt       DateTime?   @map("auto_close_at")

  items        Item[]
  participants Participant[]
  claims       Claim[]
  finalTotals  FinalTotal[]
  events       Event[]

  @@map("bills")
}

enum BillStatus {
  DRAFT
  OPEN
  PENDING
  FINALIZED
  ARCHIVED
}

model Item {
  id         String   @id @default(uuid())
  billId     String   @map("bill_id")
  name       String
  quantity   Int      @default(1)
  unitPrice  Decimal  @map("unit_price") @db.Decimal(12, 2)
  totalPrice Decimal  @map("total_price") @db.Decimal(12, 2)
  notes      String?
  createdAt  DateTime @default(now()) @map("created_at")

  bill   Bill    @relation(fields: [billId], references: [id], onDelete: Cascade)
  claims Claim[]

  @@map("items")
}

model Participant {
  id          String   @id @default(uuid())
  billId      String   @map("bill_id")
  sessionId   String?  @map("session_id")
  userId      String?  @map("user_id")
  displayName String   @map("display_name")
  joinedAt    DateTime @default(now()) @map("joined_at")
  isPayer     Boolean  @default(false) @map("is_payer")
  paidAmount  Decimal  @default(0) @map("paid_amount") @db.Decimal(12, 2)

  bill        Bill        @relation(fields: [billId], references: [id], onDelete: Cascade)
  claims      Claim[]
  finalTotals FinalTotal[]

  @@map("participants")
}

model Claim {
  id           String   @id @default(uuid())
  billId       String   @map("bill_id")
  itemId       String   @map("item_id")
  participantId String  @map("participant_id")
  shareCount   Int      @default(1) @map("share_count")
  createdAt    DateTime @default(now()) @map("created_at")

  bill        Bill        @relation(fields: [billId], references: [id], onDelete: Cascade)
  item        Item        @relation(fields: [itemId], references: [id], onDelete: Cascade)
  participant Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([itemId, participantId])
  @@map("claims")
}

model FinalTotal {
  id           String   @id @default(uuid())
  billId       String   @map("bill_id")
  participantId String  @map("participant_id")
  subtotal     Decimal  @db.Decimal(12, 2)
  taxShare     Decimal  @map("tax_share") @db.Decimal(12, 2)
  serviceShare Decimal  @map("service_share") @db.Decimal(12, 2)
  tipShare     Decimal  @map("tip_share") @db.Decimal(12, 2)
  total        Decimal  @db.Decimal(12, 2)

  bill        Bill        @relation(fields: [billId], references: [id], onDelete: Cascade)
  participant Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([billId, participantId])
  @@map("final_totals")
}

model Event {
  id          String   @id @default(uuid())
  billId      String?  @map("bill_id")
  actorSession String? @map("actor_session")
  action      String
  payload     Json?
  createdAt   DateTime @default(now()) @map("created_at")

  bill Bill? @relation(fields: [billId], references: [id], onDelete: Cascade)

  @@map("events")
}


